name: Upstream Sync

permissions:
  contents: write

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  sync_latest_from_upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 

      - name: Sync Upstream
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              // Backup user's wrangler.json (if exists and contains database_id)
              const wranglerPath = '_workers_next/wrangler.json';
              let userWrangler = null;
              
              if (fs.existsSync(wranglerPath)) {
                const content = fs.readFileSync(wranglerPath, 'utf8');
                // Only backup if user has customized it (contains d1_databases)
                if (content.includes('d1_databases')) {
                  userWrangler = content;
                  console.log('üì¶ Backed up user wrangler.json with D1 config');
                }
              }
              
              // Configure Git
              await exec.exec('git', ['config', '--global', 'user.name', 'GitHub Actions']);
              await exec.exec('git', ['config', '--global', 'user.email', 'actions@github.com']);

              // Add Upstream
              await exec.exec('git', ['remote', 'add', 'upstream', 'https://github.com/chatgptuk/ldc-shop.git']);
              await exec.exec('git', ['fetch', 'upstream']);

              // Hard Reset to Upstream Main
              await exec.exec('git', ['checkout', 'main']);
              await exec.exec('git', ['reset', '--hard', 'upstream/main']);
              
              // Restore user's wrangler.json if it was backed up
              if (userWrangler) {
                fs.writeFileSync(wranglerPath, userWrangler);
                await exec.exec('git', ['add', wranglerPath]);
                
                // Only commit if there are changes
                try {
                  await exec.exec('git', ['diff', '--cached', '--quiet']);
                  console.log('‚ÑπÔ∏è No changes to wrangler.json, skipping commit');
                } catch {
                  // diff --quiet returns non-zero if there are changes
                  await exec.exec('git', ['commit', '-m', 'chore: preserve user wrangler.json config']);
                  console.log('‚úÖ Restored user wrangler.json with D1 config');
                }
              }

              // Force Push
              await exec.exec('git', ['push', 'origin', 'main', '--force']);
              
              console.log('‚úÖ Sync completed successfully');
              
            } catch (error) {
              core.setFailed(`Sync failed: ${error.message}`);
            }
  
  # Trigger deployment after successful sync
  trigger_deploy:
    needs: sync_latest_from_upstream
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Deploy Workflow
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yml',
              ref: 'main'
            });
            console.log('‚úÖ Triggered deployment workflow');

